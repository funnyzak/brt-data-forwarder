# CLAUDE.md - 开发指导文档

## 项目概述

**BRT Cloud Data Forwarder** 是一个轻量级的数据转发服务器，专门用于处理环境传感器数据的接收、缓存和转发。

### 核心特性
- **高性能缓存**: 线程安全的内存缓存系统，支持定期持久化
- **智能数据处理**: 自动检测无效值并使用缓存值替换
- **灵活配置**: YAML配置文件 + 环境变量覆盖机制
- **多目标转发**: 支持串行转发到多个目标端点
- **认证机制**: 支持URL参数和HTTP头认证

### 技术栈
- **Web框架**: Flask 3.0+
- **配置管理**: PyYAML + 环境变量覆盖
- **缓存系统**: 自研线程安全内存缓存
- **HTTP客户端**: requests
- **日志系统**: logging + RotatingFileHandler

## 开发规范

### 代码风格
- 遵循 PEP 8 Python 代码规范
- 使用清晰的类和方法命名
- 添加必要的文档字符串和注释
- 保持代码简洁，避免过度复杂化

### 文件组织原则
```
项目根目录/
├── forwarder.py          # 主程序文件（核心业务逻辑）
├── config.yaml          # 配置文件
├── test_client.py       # 测试客户端
├── requirements.txt     # 依赖包列表
├── README.md           # 项目说明文档
└── data/               # 数据存储目录
    └── cache.json      # 缓存持久化文件
```

### Git 工作流程
- 功能开发前创建特性分支
- 保持 commit 信息简洁明确
- 重要修改前进行代码审查
- 定期合并到主分支并保持同步

### 代码质量要求
- **测试覆盖**: 新功能必须包含测试用例
- **错误处理**: 完善的异常处理和日志记录
- **性能考虑**: 注意内存使用和并发安全
- **向后兼容**: 修改时考虑配置和数据格式兼容性

## 核心架构

### 关键类职责

#### MemoryCacheWithPersistence
- **职责**: 提供线程安全的内存缓存和持久化功能
- **核心方法**:
  - `get_metric()` - 线程安全获取缓存值
  - `update_metric()` - 线程安全更新缓存值
  - `force_sync()` - 强制同步缓存到磁盘
  - `cleanup_expired_data()` - 清理过期数据

#### DataForwarder
- **职责**: 主服务器类，管理Flask应用和数据处理流程
- **核心方法**:
  - `_process_data()` - 数据处理和缓存值替换
  - `_forward_data()` - 数据转发到目标端点
  - `_authenticate()` - 请求认证验证

### 数据流转程
1. **接收数据** → HTTP请求接收和认证
2. **数据处理** → 无效值检测和缓存替换（可配置开关）
3. **缓存更新** → 线程安全的内存缓存更新
4. **数据转发** → 串行转发到多个目标端点
5. **持久化** → 后台线程定期同步缓存到磁盘

### 配置系统要点

#### 环境变量覆盖机制
- 优先级：环境变量 > 配置文件 > 默认值
- 前缀：所有环境变量使用 `BRT_` 前缀
- 层级：使用双下划线 `__` 分割配置层级
- 类型转换：支持布尔、数字、字符串自动转换

#### 关键配置项
```yaml
# 数据处理开关
processing:
  enabled: true  # 是否启用缓存值替换

# 缓存配置
cache:
  sync_interval: 30  # 同步间隔（秒）
  special_metrics:   # 特殊指标列表
    - co2
    - hcho
    - voc

# 转发目标
forwarder:
  targets:
    - url: "http://target-api/data"
      timeout: 10
```

## 开发指导

### 常见开发场景

#### 添加新的特殊指标
1. 在 `config.yaml` 的 `cache.special_metrics` 中添加指标名称
2. 系统自动处理，无需修改代码逻辑

#### 扩展缓存类型
1. 在 `_init_cache()` 方法中添加新的缓存类型判断
2. 实现对应的缓存类接口（线程安全）
3. 更新配置文件说明

#### 修改认证逻辑
1. 扩展 `_authenticate()` 方法
2. 支持JWT、OAuth2、IP白名单等新认证方式
3. 更新配置文件认证相关设置

#### 添加转发目标
1. 在配置文件的 `forwarder.targets` 中添加新目标
2. 支持不同认证方式和自定义headers

### 测试策略

#### 单元测试
- 缓存系统的线程安全性测试
- 数据处理逻辑的正确性测试
- 配置加载和环境变量覆盖测试

#### 集成测试
- 完整的数据接收、处理、转发流程测试
- 多目标并发的稳定性测试
- 异常情况的错误处理测试

#### 性能测试
- 高并发请求的处理能力测试
- 大量数据的缓存性能测试
- 长时间运行的稳定性测试

### 扩展开发方向

#### 功能扩展
- **数据预处理**: 添加数据清洗、格式转换功能
- **批量处理**: 支持批量数据接收和处理
- **监控面板**: Web界面实时监控服务状态
- **API扩展**: 提供更多管理和查询接口

#### 技术升级
- **异步处理**: 使用asyncio提升并发性能
- **数据库存储**: SQLite/PostgreSQL替换JSON文件
- **消息队列**: RabbitMQ/Kafka处理高并发
- **容器化部署**: Docker支持

## 运维要点

### 部署配置
- 使用环境变量管理生产环境配置
- 确保日志目录和数据目录权限正确
- 配置日志轮转避免磁盘空间问题
- 设置适当的缓存同步间隔

### 故障排查

#### 缓存问题
- **缓存值不更新**: 检查 `special_metrics` 配置
- **缓存文件损坏**: 删除 `data/cache.json` 重启服务
- **内存使用过高**: 调整同步间隔，定期清理过期数据

#### 转发问题
- **转发失败**: 检查目标URL可达性和网络连接
- **转发超时**: 调整timeout配置，检查网络延迟
- **认证失败**: 验证token配置和认证方式

#### 配置问题
- **环境变量不生效**: 检查变量名格式和导出状态
- **类型转换错误**: 验证环境变量值格式

### 监控要点
- 监控服务进程运行状态
- 跟踪日志文件大小和错误频率
- 监控内存使用和缓存性能
- 定期检查转发成功率

## 快速参考

### 环境变量映射
```bash
BRT_SERVER__PORT=8080                    # 服务端口
BRT_PROCESSING__ENABLED=false           # 禁用数据处理
BRT_CACHE__SYNC_INTERVAL=60             # 缓存同步间隔
BRT_LOGGING__LEVEL=DEBUG                # 日志级别
```

### API接口摘要
- `POST /receive_brt_data` - 数据接收接口
- `GET /api/device/<ble_addr>` - 设备查询接口
- `GET /health` - 健康检查接口

### 常用调试命令
```bash
# 查看实时日志
tail -f logs/forwarder.log

# 测试接口连通性
curl -X POST http://localhost:8080/receive_brt_data \
     -H "Authorization: your-token" \
     -d '{"seq_no":1,"devices":[]}'

# 检查环境变量
env | grep BRT_
```

### 核心文件位置
- 主程序: `forwarder.py`
- 配置文件: `config.yaml`、`config.yaml.example`
- 缓存文件: `data/cache.json`
- 日志文件: `logs/forwarder.log`

---

**注意**: 本文档专注于开发规范和实用指导，详细安装使用说明请参考 README.md